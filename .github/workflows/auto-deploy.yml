name: Auto Deploy

on:
  push:
    branches: [main]
    paths:
      - "control-plane/**"
      - "ui/**"
      - "shared/**"
      - "terraform/**"
      - "Dockerfile.*"
      - "scripts/deploy.sh"
      - "scripts/cloud-smoke.sh"
      - ".github/workflows/auto-deploy.yml"
  workflow_dispatch:
    inputs:
      apply:
        description: "Apply after plan (true/false)"
        required: true
        type: boolean
        default: true
      environment:
        description: "Terraform environment"
        required: true
        default: "demo"
      image_tag:
        description: "Container image tag override (optional)"
        required: false
        default: ""

concurrency:
  group: feature-flag-platform-demo-deploy
  cancel-in-progress: true

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      has_required_secrets: ${{ steps.check.outputs.has_required_secrets }}
    steps:
      - id: check
        shell: bash
        env:
          AWS_DEPLOY_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          FF_DB_PASSWORD: ${{ secrets.FF_DB_PASSWORD }}
        run: |
          has_required_secrets=true

          if [[ -z "${AWS_DEPLOY_ROLE_ARN}" || -z "${FF_DB_PASSWORD}" ]]; then
            has_required_secrets=false
            echo "::warning::Skipping auto deploy: missing AWS_DEPLOY_ROLE_ARN and/or FF_DB_PASSWORD."
          fi

          echo "has_required_secrets=${has_required_secrets}" >> "${GITHUB_OUTPUT}"

  deploy:
    needs: preflight
    if: ${{ needs.preflight.outputs.has_required_secrets == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      TF_ENVIRONMENT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'demo' }}
      DB_PASSWORD: ${{ secrets.FF_DB_PASSWORD }}
      DEPLOY_APPLY: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.apply || 'true' }}
      IMAGE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.image_tag != '' && github.event.inputs.image_tag || github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Deploy
        run: |
          chmod +x scripts/deploy.sh
          APPLY="${DEPLOY_APPLY}" ./scripts/deploy.sh

      - name: Cloud smoke
        if: ${{ env.DEPLOY_APPLY == 'true' }}
        run: |
          chmod +x scripts/cloud-smoke.sh
          ./scripts/cloud-smoke.sh
